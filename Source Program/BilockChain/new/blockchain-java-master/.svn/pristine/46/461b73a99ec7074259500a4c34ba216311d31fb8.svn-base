package com.aizone.blockchain.web.controller;

import com.aizone.blockchain.conf.Settings;
import com.aizone.blockchain.constants.TransactionConstants;
import com.aizone.blockchain.core.Block;
import com.aizone.blockchain.core.BlockBody;
import com.aizone.blockchain.core.BlockChain;
import com.aizone.blockchain.core.BlockHeader;
import com.aizone.blockchain.core.Transaction;
import com.aizone.blockchain.dao.PaymentRecordDao;
import com.aizone.blockchain.dao.TransactionRecordDao;
import com.aizone.blockchain.utils.CreateAFile;
import com.aizone.blockchain.utils.JsonVo;
import com.google.gson.Gson;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.PrintStream;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.math.RoundingMode;
import java.net.HttpURLConnection;
import java.net.URL;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;
import org.apache.catalina.servlet4preview.http.HttpServletRequest;
import org.apache.commons.codec.binary.Base64;
import org.bitcoinj.core.ECKey;
import org.bitcoinj.core.Wallet;
import org.bitcoinj.crypto.DeterministicKey;
import org.bitcoinj.params.TestNet3Params;
import org.spongycastle.util.encoders.Hex;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * paypal查询及兑换接口
 * @author Kelly
 *
 */
@RestController
@RequestMapping({"/paypal"})
public class PaypalCommonController
{
  private static final String TOKEN_URL = "https://api.paypal.com/v1/oauth2/token";
  private static final String PAYMENT_DETAIL = "https://api.paypal.com/v1/payments/payment/";
  private static final String clientId = "AQ5yRaEsLWJuabKBn9c16VaVu0PKI7b7ohjiOfuDz_UVv1BVNosCdnAmBkrOwYjF9hgyyN6b5xmpI5wN";
  private static final String secret = "EMDe_nRWkXhNNqjCXpI5Bpo07_RRl4_1j0_OME7LqMd82nRcze3Aq-5P3urOwOp3zwMGtkHNbAtHTxNe";
  private static final String ANDA_SERVER_ANDA_ADDRESS = "8f863ab09ab147df18755ea64a679294594a1266";
  @Autowired
  private BlockChain blockChain;
  @Autowired
  private Settings settings;
  @Autowired
  private TransactionRecordDao txRecord;
  
  /**
   * 查询及兑换
   * @param request
   * @return
   */
  @PostMapping({"/payment/getResult"})
  public JsonVo paypalPaymentResult(HttpServletRequest request)
  {
    String txnId = request.getParameter("txnId");
    String andaAddress = request.getParameter("andaAddress");
    PaypalCommonController payment = new PaypalCommonController();
    boolean success = false;
    Double usdAmount = null;
    BigDecimal andaAmount = null;
    try
    {
      do
      {
        success = payment.verifyPayment(txnId);
      } while (!success);
      
      if (success)
      {
        usdAmount = payment.getPaymentAmount(txnId);
        
        andaAmount = excuteExchangeTransaction(andaAddress, usdAmount);
      }
    }
    catch (Exception e) {
      e.printStackTrace();
    }
    String result = success ? usdAmount + "美元支付完成,兑换安达通证：" + andaAmount + "个" : "支付校验失败";
    Map<String, String> map = new HashMap();
    map.put("paymentResult", result);
    JsonVo vo = JsonVo.success();
    vo.setItem(map);
    return vo;
  }
  


  private String getAccessToken()
  {
    try
    {
      URL url = new URL("https://api.paypal.com/v1/oauth2/token");
      String authorization = "AQ5yRaEsLWJuabKBn9c16VaVu0PKI7b7ohjiOfuDz_UVv1BVNosCdnAmBkrOwYjF9hgyyN6b5xmpI5wN:EMDe_nRWkXhNNqjCXpI5Bpo07_RRl4_1j0_OME7LqMd82nRcze3Aq-5P3urOwOp3zwMGtkHNbAtHTxNe";
      authorization = Base64.encodeBase64String(authorization.getBytes());
      
      HttpURLConnection conn = (HttpURLConnection)url.openConnection();
      conn.setRequestMethod("POST");
      
      conn.setRequestProperty("Accept", "application/json");
      conn.setRequestProperty("Accept-Language", "en_US");
      conn.setRequestProperty("Authorization", "Basic " + authorization);
      

      String params = "grant_type=client_credentials";
      conn.getOutputStream().write(params.getBytes());
      
      InputStreamReader inStream = new InputStreamReader(conn.getInputStream());
      BufferedReader reader = new BufferedReader(inStream);
      StringBuilder result = new StringBuilder();
      String lineTxt = null;
      while ((lineTxt = reader.readLine()) != null) {
        result.append(lineTxt);
      }
      reader.close();
      String accessTokey = JSONObject.fromObject(result.toString()).optString("access_token");
      System.out.println("getAccessToken:" + accessTokey);
      return accessTokey;
    } catch (Exception err) {
      err.printStackTrace();
    }
    return null;
  }
  


  public String getPaymentDetails(String paymentId)
  {
    try
    {
      URL url = new URL("https://api.paypal.com/v1/payments/payment/" + paymentId);
      HttpURLConnection conn = (HttpURLConnection)url.openConnection();
      conn.setRequestMethod("GET");
      
      conn.setRequestProperty("Accept", "application/json");
      conn.setRequestProperty("Authorization", "Bearer " + getAccessToken());
      

      InputStreamReader inStream = new InputStreamReader(conn.getInputStream());
      BufferedReader reader = new BufferedReader(inStream);
      StringBuilder result = new StringBuilder();
      String lineTxt = null;
      while ((lineTxt = reader.readLine()) != null) {
        result.append(lineTxt);
      }
      reader.close();
      return result.toString();
    } catch (Exception err) {
      err.printStackTrace();
    }
     return null;
  }
  


  public boolean verifyPayment(String paymentId)
    throws Exception
  {
    PaymentRecordDao payDao = new PaymentRecordDao();
    payDao.logSaveTest("PaypalCommonController--verifyPayment1", "verifyPayment");
    String str = getPaymentDetails(paymentId);
    payDao.logSaveTest("PaypalCommonController--verifyPayment2", str);
    
    System.out.println("paypal回传的json信息;" + str);
    JSONObject detail = JSONObject.fromObject(str);
    payDao.logSaveTest("PaypalCommonController--verifyPayment3", detail.optString("state"));
    

    if ("approved".equals(detail.optString("state"))) {
      JSONObject transactions = detail.optJSONArray("transactions").optJSONObject(0);
      JSONObject amount = transactions.optJSONObject("amount");
      JSONArray relatedResources = transactions.optJSONArray("related_resources");
      
      double total = 0.0D;
      System.out.println("amount.optDouble('total'):" + amount.optDouble("total"));
      payDao.logSaveTest("PaypalCommonController--verifyPayment4", String.valueOf(amount.optDouble("total")));
      



      String currency = "USD";
      if (!currency.equals(amount.optString("currency"))) {
        return false;
      }
      
      int i = 0; for (int j = relatedResources.size(); i < j; i++) {
        JSONObject sale = relatedResources.optJSONObject(i).optJSONObject("sale");
        payDao.logSaveTest("PaypalCommonController--verifyPayment5", String.valueOf(sale));
        
        if ((sale != null) && 
          (!"completed".equals(sale.optString("state")))) {
          payDao.logSaveTest("PaypalCommonController--verifyPayment5", sale.optString("state"));
          System.out.println("子订单未完成,订单状态:" + sale.optString("state"));
        }
      }
      
      return true;
    }
    return false;
  }
  



  public Double getPaymentAmount(String paymentId)
    throws Exception
  {
    PaymentRecordDao payDao = new PaymentRecordDao();
    payDao.logSaveTest("PaypalCommonController-getPaymentAmount1", "getPaymentAmount");
    String str = getPaymentDetails(paymentId);
    JSONObject detail = JSONObject.fromObject(str);
    
    JSONObject amount = null;
    payDao.logSaveTest("PaypalCommonController-getPaymentAmount2", detail.optString("state"));
    if ("approved".equals(detail.optString("state"))) {
      JSONObject transactions = detail.optJSONArray("transactions").optJSONObject(0);
      amount = transactions.optJSONObject("amount");
    }
    payDao.logSaveTest("PaypalCommonController-getPaymentAmount3", String.valueOf(amount.optDouble("total")));
    return Double.valueOf(amount.optDouble("total"));
  }
  


  /**
   * 兑换交易
   * @param andaAddress
   * @param usdAmount
   * @return
   */
  public BigDecimal excuteExchangeTransaction(String andaAddress, Double usdAmount)
  {
    PaymentRecordDao payDao = new PaymentRecordDao();
    payDao.logSaveTest("PaypalCommonController-excuteExchangeTransaction1", "excuteExchangeTransaction");
    TransactionRecordDao dao = new TransactionRecordDao();
     Map<String, String> resultMap = dao.exchangeRate("USD");
    String exchangeRate = (String)resultMap.get("exchangeRate");
    BigDecimal bdUsdAmount = new BigDecimal(usdAmount.doubleValue());
    BigDecimal bdExchangeRateNumerator = new BigDecimal("1");
    BigDecimal bdExchangeRateDenominator = new BigDecimal(exchangeRate);
    BigDecimal bdExchangeRate = bdExchangeRateNumerator.divide(bdExchangeRateDenominator, 8, RoundingMode.HALF_UP);
    BigDecimal andaAmountActuall = bdUsdAmount.multiply(bdExchangeRate);
    BigDecimal andaAmountActual = andaAmountActuall.setScale(8, 5);
    Map<String, Object> map_ = new HashMap();
    map_.put("AndaAddress", andaAddress);
    map_.put("andaAmountActual", andaAmountActual);
    try {
      tranSactionRun(map_);
    }
    catch (Exception e) {
      e.printStackTrace();
    }
    return andaAmountActual;
  }
  


  /**
   * 执行兑换
   * @param map_
   * @return
   * @throws Exception
   */
  public String tranSactionRun(@RequestBody Map<String, Object> map_)
    throws Exception
  {
    Wallet wallet = new Wallet(TestNet3Params.get());
    String data_ = UUID.randomUUID().toString();
    
    String sendAddress = ANDA_SERVER_ANDA_ADDRESS;
    Transaction tx = new Transaction();
    tx.setSender(sendAddress);
    tx.setRecipient(map_.get("AndaAddress").toString());
    tx.setAmount(new BigDecimal(map_.get("andaAmountActual") + ""));
    System.out.println(tx.getAmount());
    tx.setTimestamp(Long.valueOf(System.currentTimeMillis()));
    tx.setData(data_);
    String publicKey = Hex.toHexString(wallet.getWatchingKey().getPubKey());
    tx.setPublicKey(publicKey);
    String hash = tx.hash();
    tx.setTxHash(hash);
   
    ECKey eckey1 = ECKey.fromPrivate(new BigInteger(wallet.getWatchingKey().getPrivKeyBytes33()));
    String data = tx.toStringOragin();
    String sign = eckey1.signMessage(data);
    tx.setSign(sign);
    Transaction txNew = this.blockChain.sendTransaction(tx);
    this.txRecord.addPaypalExchangeRecord(txNew);
    if (this.settings.isAutoMining()) {
      Block block = this.blockChain.mining();
    
      DateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
      Map<String, Object> mapNew = new HashMap();
      Map<String, Object> map1 = new HashMap();
      Map<String, Object> map2 = new HashMap();
    
      map1.put("index", block.getHeader().getIndex());
      map1.put("hash", block.getHeader().getHash());
      map1.put("previousHash", block.getHeader().getPreviousHash());
      map1.put("difficulty", block.getHeader().getDifficulty());
      map1.put("nonce", block.getHeader().getNonce());
      mapNew.put("BlockHeader", map1);
      map2.put("sender", ANDA_SERVER_ANDA_ADDRESS);
      map2.put("recipient", ((Transaction)block.getBody().getTransactions().get(1)).getRecipient());
      map2.put("publicKey", ((Transaction)block.getBody().getTransactions().get(1)).getPublicKey());
      map2.put("txHash", ((Transaction)block.getBody().getTransactions().get(1)).getTxHash());
      map2.put("USD", new BigDecimal(((Transaction)block.getBody().getTransactions().get(1)).getAmount() + "").multiply(new BigDecimal(TransactionConstants.USD_EXCHANGE_RATE)));
      map2.put("amount", ((Transaction)block.getBody().getTransactions().get(1)).getAmount());
      map2.put("time", format.format(((Transaction)block.getBody().getTransactions().get(1)).getTimestamp()));
      mapNew.put("Body", map2);
      Gson gson = new Gson();
      String ss = gson.toJson(mapNew);
     
      CreateAFile cc = new CreateAFile();
      System.out.println("块" + format.format(((Transaction)block.getBody().getTransactions().get(1)).getTimestamp()) + "");
      cc.CreateFile(ss, format.format(((Transaction)block.getBody().getTransactions().get(1)).getTimestamp()) + "_" + block.getHeader().getIndex());
      System.out.println("*********************打印块*****************************");
    } else {
      this.blockChain.runTransaction(tx);
    }
    return "SUCCESS";
  }
}

